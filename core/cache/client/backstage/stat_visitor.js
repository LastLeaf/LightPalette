// Copyright 2014 LastLeaf, LICENSE: github.lastleaf.me/MIT
"use strict";var POST_LIST_LEN=20;fw.main(function(t){var a=t.tmpl,e=a.i18n,i=function(){if(!t.destroyed){var i=lp.backstage.userInfo;if(i._id){var n=$("#content").html(a.main()),s=n.find(".table"),d=n.find(".stat_time"),o=n.find(".stat_meta");lp.backstage.statRange?d.val(lp.backstage.statRange):lp.backstage.statRange=d.val(),d.change(function(){lp.backstage.statRange=d.val(),r.setPage(0,1)});var r=lp.tableBuilder(s,{idCol:"_id",editMore:!0,noRemove:!0},[{id:"dateTimeString",name:e("Time"),input:"add"},{id:"post._id",type:"hidden",input:"add"},{id:"post.title",name:e("Post"),input:"add"},{id:"ip",name:e("IP Address"),input:"add"},{id:"extra",type:"extra",input:"add"}]).data(function(e){var i={timeRange:lp.backstage.statRange,visitor:fw.getArgs().id,from:e*POST_LIST_LEN,count:POST_LIST_LEN};t.rpc("stat:visitor",i,function(t){o.html(a.statMeta({visits:t.total,id:fw.getArgs().id})),r.setTotal(Math.ceil(t.total/POST_LIST_LEN));for(var e=t.rows,i=0;i<t.rows.length;i++){t.rows[i]}r.set(e)},function(t){lp.backstage.showError(t)})}).setPage(0,1);r.change(function(t){fw.go("/backstage/stat/post/"+t.post._id)}),d.change(function(){r.setPage(0,1)})}}};lp.backstage.userInfo?i():t.parent.on("userInfoReady",i)});
