// Copyright 2014 LastLeaf, LICENSE: github.lastleaf.me/MIT
"use strict";var FILES_LIST_LEN=20;fw.main(function(n){var t=n.tmpl,i=t.i18n,e=function(e){var a=$("#content").html(t.main(e)),o=a.find(".table"),r=a.find(".user").val(e.curAuthor),d=a.find(".path").text("/"),l="/",f={},s="http://"+location.host+"/files/",u=function(t,e){e?(".."===e&&(e=l.slice(0,l.lastIndexOf("/",l.length-2))),"/"!==e.slice(-1)&&(e+="/"),l=e):e=l,d.text(e),a.find(".location input").prop("disabled",!0),f={},n.rpc("file:list",{user:r.val(),path:e,from:t*FILES_LIST_LEN,count:FILES_LIST_LEN},function(n){c.setTotal(Math.ceil(n.total/FILES_LIST_LEN));for(var t=n.rows,o=s+r.val()+e,d=0;d<t.length;d++)t[d].dir?(t[d].dir="yes",t[d].extra=i("folder")):(t[d].dir="",t[d].extra=o+t[d].name);c.set(t),a.find(".location input").prop("disabled",!1)},function(n){lp.backstage.showError(n),a.find(".location input").prop("disabled",!1)})};r.change(function(){u(0,"/")}),a.find(".path_parent").click(function(){u(0,"..")});var c=lp.tableBuilder(o,{idCol:"name",editMore:!0},[{id:"name",name:i("Name"),input:"add"},{id:"dir",type:"hidden"},{id:"dateTimeString",name:i("Modified Time"),input:"add"},{id:"extra",type:"extra",input:"add"}]).data(function(n){u(n)}).setPage(0,1);c.change(function(n,t){n.dir?u(0,l+t):window.open(s+r.val()+l+t,"_blank"),c.enableModify(t)}),c.remove(function(t){n.rpc("file:remove",{user:r.val(),path:l,name:t},function(){c.removeRow(t)},function(n){lp.backstage.showError(n),c.enableModify(t)})});var p=a.find(".create_dir");n.form(p[0],function(){p.find("input").prop("disabled",!0),p.find("[name=user]").val(r.val()),p.find("[name=path]").val(l)},function(n){n.dir="yes",n.extra=i("folder"),c.setRow(n.name,n),p.find("input").prop("disabled",!1),p[0].reset()},function(n){lp.backstage.showError(n),p.find("input").prop("disabled",!1)});var m=a.find(".upload_iframe").load(function(){h.prop("disabled")&&(c.setPage(),h.prop("disabled",!1))}),h=a.find(".upload_submit").click(function(){m.contents().find("[name=user]").val(r.val()),m.contents().find("[name=path]").val(l),m.contents().find("form").submit(),this.disabled=!0})},a=function(){var t=lp.backstage.userInfo;"editor"===t.type||"admin"===t.type?n.rpc("user:listAuthors",function(n){e({authors:n,curAuthor:t._id})},function(n){lp.backstage.showError(n)}):e({authors:[t],curAuthor:t._id})};lp.backstage.userInfo?a():n.parent.on("userInfoReady",a)});
