// Copyright 2014 LastLeaf, LICENSE: github.lastleaf.me/MIT
"use strict";var POST_LIST_LEN=20;fw.main(function(t){var a=t.tmpl,e=a.i18n,n=function(){if(!t.destroyed){var n=lp.backstage.userInfo;if(n._id){var i=$("#content").html(a.main()),s=i.find(".table"),o=i.find(".stat_time"),d=i.find(".stat_title"),r=i.find(".stat_meta");lp.backstage.statRange?o.val(lp.backstage.statRange):lp.backstage.statRange=o.val(),o.change(function(){lp.backstage.statRange=o.val(),g.setPage(0,1)});var g=lp.tableBuilder(s,{idCol:"_id",editMore:!0,noRemove:!0},[{id:"dateTimeString",name:e("Time"),input:"add"},{id:"ip",name:e("IP Address"),input:"add"},{id:"sid",name:e("Visitor ID"),input:"add"},{id:"extra",type:"extra",input:"add"}]).data(function(e){var n={timeRange:lp.backstage.statRange,post:fw.getArgs().id,from:e*POST_LIST_LEN,count:POST_LIST_LEN};t.rpc("stat:post",n,function(t){d.text(t.post.title),r.html(a.statMeta(t)),g.setTotal(Math.ceil(t.visits/POST_LIST_LEN));for(var e=t.rows,n=0;n<t.rows.length;n++){t.rows[n]}g.set(e)},function(t){lp.backstage.showError(t)})}).setPage(0,1);g.change(function(t){fw.go("/backstage/stat/visitor/"+t.sid)}),o.change(function(){g.setPage(0,1)})}}};lp.backstage.userInfo?n():t.parent.on("userInfoReady",n)});
