// Copyright 2014 LastLeaf, LICENSE: github.lastleaf.me/MIT
"use strict";var LIST_LEN=20;fw.main(function(e){var n=e.tmpl,r=n.i18n,o=function(o){var t=(lp.backstage.userInfo,$("#content").html(n.main())),i=t.find(".table"),a=lp.tableBuilder(i,{idCol:"_id"},[{id:"title",name:r("Title")},{id:"_id",name:r("Short Name"),input:"add"},{id:"owner._id",name:r("Main Author"),input:o},{id:"description",type:"extra"}],{}).data(function(n){e.rpc("series:list",{from:n*LIST_LEN,count:LIST_LEN},function(e){a.setTotal(Math.ceil(e.total/LIST_LEN));var n=e.rows;a.set(n)},function(e){lp.backstage.showError(e)})}).setPage(0,1);a.add(function(n){n.owner=n.owner._id,e.rpc("series:create",n,function(){n.owner={_id:n.owner},a.addRow(n._id,n)},function(e){lp.backstage.showError(e),a.enableAdd()})}),a.change(function(n){n.owner=n.owner._id,e.rpc("series:modify",n,function(){n.owner={_id:n.owner},a.setRow(n._id,n)},function(e){lp.backstage.showError(e),a.enableModify(n._id)})}),a.remove(function(n){e.rpc("series:remove",{_id:n},function(){a.removeRow(n)},function(e){lp.backstage.showError(e),a.enableModify(n)})})},t=function(){if("writer"===lp.backstage.userInfo.type){var n={};return n[e.parent.userInfo._id]=e.parent.userInfo.displayName,void o(n)}e.rpc("user:listAuthors",function(e){for(var n={"":""},r=0;r<e.length;r++)n[e[r]._id]=e[r].displayName;o(n)},function(e){lp.backstage.showError(e)})};lp.backstage.userInfo?t():e.parent.on("userInfoReady",t)});
