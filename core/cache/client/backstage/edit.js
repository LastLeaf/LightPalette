// Copyright 2014 LastLeaf, LICENSE: github.lastleaf.me/MIT
"use strict";var SERIES_LIST_LEN=10;fw.main(function(e){var i=e.tmpl,t=(i.i18n,null),n=function(n,a){var r=$("#content").html(i.main(a)),o=r.find(".editor");o.find("[name]").each(function(){var e=$(this).attr("name");n[e]&&"string"==typeof n[e]&&(this.value=n[e])}),o.find("[name=author]").val(n.author._id),"draft"!==n.status&&o.find("[name=timeString]").val(n.dateTimeString);for(var s={},c=0;c<n.category.length;c++)s[n.category[c]._id]=!0;o.find('[name="category[]"]').each(function(){s.hasOwnProperty(this.value)&&s[this.value]&&(this.checked=!0)}),o.find("[name=tag]").val(n.tag.join("\r\n"));var d=lp.driverEditor(n.type,r.find(".driver")[0],n,t),l=o.find(".sidebar_series"),f=o.find(".sidebar_series_select"),u=o.find("[name=series]");f.on("change","[name=seriesRadio]",function(){u.val(this.value)});var p=function(t){f.fadeTo(200,.5),e.rpc("series:list",{from:t*SERIES_LIST_LEN,count:SERIES_LIST_LEN},function(e){u.val(""),t>0&&(e.prev=!0),t+1<Math.ceil(e.total/SERIES_LIST_LEN)&&(e.next=!0),f.html(i.seriesSelect(e)).find(".sidebar_series_prev").click(function(){p(t-1)}).end().find(".sidebar_series_next").click(function(){p(t+1)}).end().fadeTo(200,1)},function(e){lp.backstage.showError(e)})};n.series?($('<option value="id-'+escape(n.series._id)+'" selected></option>').text(n.series.title).appendTo(l),u.val(n.series._id)):(l.val("none"),u.val("")),l.change(function(){var e=l.val();"none"===e?(f.hide(),u.val("")):"select"===e?(p(0),u.val("")):(f.hide(),u.val(unescape(l.val().slice(3))))}),r.find(".editor_preview").click(function(){window.open("/backstage/preview/"+n._id,"preview")});var v=r.find(".editor_save").click(function(){o.submit()});o.submit(function(i){i.preventDefault();for(var t={_id:n._id},a=d.get(),r=o[0].elements,s=0;s<r.length;s++){var c=r[s].name;c&&("radio"!==r[s].type&&"checkbox"!==r[s].type||r[s].checked!==!1)&&("[]"===c.slice(-2)?(c=c.slice(0,-2),t[c]?t[c].push(r[s].value):t[c]=[r[s].value]):t[c]=r[s].value)}for(var l in a)t[l]=a[l];v.prop("disabled",!0),e.rpc(o.attr("action")+":"+o.attr("method"),t,function(){v.prop("disabled",!1)},function(e){v.prop("disabled",!1),lp.backstage.showError(e)}),v.prop("disabled",!0)})},a=function(){t=lp.backstage.userInfo;var i=function(i){e.rpc("post:get",{_id:fw.getArgs()["*"],originalTimeFormat:"yes"},function(a){e.rpc("category:list",function(e){n(a,{categories:e,authors:i,write:"contributor"!==t.type,edit:"editor"===t.type||"admin"===t.type})},function(e){lp.backstage.showError(e)})},function(e){lp.backstage.showError(e)})};"editor"===t.type||"admin"===t.type?e.rpc("user:listAuthors",function(e){i(e)},function(e){lp.backstage.showError(e)}):i()};lp.backstage.userInfo?a():e.parent.on("userInfoReady",a)});
