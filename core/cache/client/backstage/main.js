// Copyright 2014 LastLeaf, LICENSE: github.lastleaf.me/MIT
"use strict";fw.main(function(e){var t=e.tmpl;lp.tableBuilder.i18n=t.i18n,lp.backstage={};var a=fw.version;a.indexOf("~")>=0&&(a=a.slice(0,a.indexOf("~")));var r=$(t.main()).appendTo(document.body);$("#content").html(t.busy());var n=r.find("#tabbar");lp.backstage.showBusy=function(){$("#content").html(t.busy())},e.on("childUnload",lp.backstage.showBusy),lp.backstage.updateTabStyle=function(){var e=fw.getPath().match(/^\/[^\/]+\/(\w+)/),t=e[1];n.find(".tab_current").removeClass("tab_current"),n.find(".tab_"+t).addClass("tab_current")},e.on("childLoadStart",lp.backstage.updateTabStyle),$(window).resize(function(){$("#backstage").height(document.documentElement.clientHeight)}),$("#backstage").height(document.documentElement.clientHeight);var i=$("#errors");lp.backstage.showError=function(e,a){var r=!1;e=e||"timeout";var n=t.error[e];a&&(n+=" "+a);var o=$("<div></div>").text(n).appendTo(i).hide().fadeIn(200).click(function(){r||(r=!0,o.fadeOut(200,function(){o.remove()}))})},e.rpc("user:current",function(a){if("admin"===a.type)var r=t.userTabs({contrib:!0,write:!0,edit:!0,admin:!0});else if("editor"===a.type)var r=t.userTabs({contrib:!0,write:!0,edit:!0});else if("writer"===a.type)var r=t.userTabs({contrib:!0,write:!0});else if("contributor"===a.type)var r=t.userTabs({contrib:!0});else var r=t.userTabs();$("#tabbar").html(r),lp.backstage.updateTabStyle(),a._id&&$(".header_right").html(t.userInfo(a)).find(".logout").click(function(e){e.preventDefault(),lp.logout(function(){return location.href="/backstage/home",!1})}),lp.backstage.userInfo=a,e.emit("userInfoReady")},lp.backstage.showError)});
