// Copyright 2014 LastLeaf, LICENSE: github.lastleaf.me/MIT
"use strict";!function(){if(!window.console){var e=function(){};window.console={log:e,info:e,warn:e,error:e}}var t=fw.uuid=function(){var e=function(e){return"undefined"!=typeof e?(e+65536).toString(16).slice(1):Math.floor(65536*(1+Math.random())).toString(16).slice(1)};if(window.crypto&&crypto.getRandomValues){var t=new Uint16Array(8);return crypto.getRandomValues(t),e(t[0])+e(t[1])+"-"+e(t[2])+"-"+e(t[3])+"-"+e(t[4])+"-"+e(t[5])+e(t[6])+e(t[7])}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};fw.loadingLogo=fw._logo?{disabled:!1,opacity:function(e){fw._logo.style.opacity=e,fw._logo.style.filter="alpha(opacity="+100*e+")"}}:{disabled:!0,opacity:function(){}};for(var n=document.head.childNodes,o=0;o<n.length;o++)"SCRIPT"===n[o].tagName&&""===n[o].getAttribute("fw")&&document.head.removeChild(n[o--]);for(var r=document.body.childNodes,o=0;o<r.length;o++)"SCRIPT"===r[o].tagName&&""===r[o].getAttribute("fw")&&document.body.removeChild(r[o--]);var i={on:function(e,t){return this.events[e]?this.events[e].push(t):this.events[e]=[t],this},off:function(e,t){if(!this.events[e])return this;for(var n=this.events[e],o=0;o<n.length;o++)if(n[o]===t){n.splice(o,1);break}return 0===n.length&&delete this.events[e],this},emit:function(e){var t=this.events[e];if(!t)return this;for(var n=[],o=0;o<t.length;o++)n.push(t[o]);for(;n.length;)try{for(var t=[],o=1;o<arguments.length;o++)t.push(arguments[o]);n.shift().apply(this,t)}catch(e){setTimeout(function(){throw e},0)}return this}};if(fw.onserverchanged=function(){"web"===fw.mode&&location.reload()},fw.onsessionlost=function(){location.reload()},fw._sessionlost=function(){localStorage["fw.sid"]="",fw.onsessionlost()},fw.auth){var a=fw.auth;delete fw.auth}else var a=localStorage["fw.sid"]||"";if("web"===fw.mode?fw.mainServerPrefix="/":fw.workingServer?(fw.mainServerPrefix=fw.workingServer[Math.floor(fw.workingServer.length*Math.random())],"/"!==fw.mainServerPrefix.slice(-1)&&(fw.mainServerPrefix+="/")):fw.mainServerPrefix="/","web"===fw.mode)fw.selectLanguage=function(e){location.replace("/~conf/lang?t="+(new Date).getTime()+"&a="+encodeURIComponent(a)+("undefined"==typeof e?"":"&l="+e)+"&r="+encodeURIComponent(fw.getPath()))};else{var l=fw.language.split(",");l[0]&&l.unshift("");var f=null;if("undefined"!=typeof localStorage["fw.lang"]){f=localStorage["fw.lang"];for(var o=0;o<l.length&&f!==l[o];o++);o>=l.length&&(delete localStorage["fw.lang"],f=null)}if(null===f){for(var c=navigator.language||"",o=0;o<l.length;o++)l[o].replace("_","-")===c&&(f=l[o]);if(null===f)for(var c=c.split(/[-_]/,2)[0],o=0;o<l.length;o++)l[o]===c&&(f=c)}fw.language=f||"",fw.selectLanguage=function(e){if("undefined"==typeof e)return delete localStorage["fw.lang"],void location.reload();for(var t=0;t<l.length&&e!==l[t];t++);t<l.length&&(localStorage["fw.lang"]=e,location.reload())}}var d=function(){var e="uninitialized",n=null,o="",r="",l={},f=[],c=[1e3,3e3,1e4,25e3,6e4],d=0,u=null,s=null,h=function(){u&&clearTimeout(u)},w=function(){h(),d=0},g=function(e){h(),s=e,u=setTimeout(function(){u=null,s()},c[d]),d<c.length-1&&d++},v=function(){u&&(clearTimeout(u),u=null,s())},m=function(){"disconnected"===e&&(e="connecting",n=new SockJS(o),n.onopen=p,n.onclose=y,n.onmessage=S)},p=function(){e="auth",n.send(location.host+"/"+fw.language+"/"+r)},b=function(){if("auth"===e){e="connected",w();for(var t in l)l[t].used=!1,l[t].pgObj.emit("socketConnect");for(;f.length;)f.shift()()}},y=function(){var t=e;if(e="uninitialized",fw.debug&&"connected"===t&&console.log("Socket disconnected."),g(P),n.onopen=n.onclose=n.onmessage=function(){},"connected"===t)for(var o in l)l[o].pgObj.emit("socketDisconnect")},S=function(e){var t=e.data,n=JSON.parse(t),o=n[0],r=n[1],n=n[2];if(o)if("~"===r.charAt(0)){r=r.slice(1);var i=l[o];if(!i)return;fw.debug&&console.log("RES "+JSON.stringify(n)),delete i.err[r];var a=i.res[r];if(!a)return;delete i.res[r],a.apply(i.pgObj,n)}else if("!"===r.charAt(0)){r=r.slice(1);var i=l[o];if(!i)return;fw.debug&&console.log("ERR "+JSON.stringify(n)),delete i.res[r];var a=i.err[r];if(!a)return;delete i.err[r],a.apply(i.pgObj,n)}else{var i=l[o];if(!i)return;fw.debug&&console.log("MSG "+r+" "+JSON.stringify(n)),n.unshift(r),i.emit.apply(i,n)}else"auth"===r&&(fw.debug&&console.log("Socket connected."),b())},_=function(e){this.used=!1,this.pgObj=e.obj,this.res={},this.err={},this.events={}};_.prototype=i;var j=function(o){do var r=t().slice(-17);while(l[r]);o.connId=r;var i=l[r]=new _(o),a=o.obj;return a.rpc=function(l){for(var c=!1,d=null,u=null,s=[],h=1;h<arguments.length;h++){if("function"==typeof arguments[h]){d=arguments[h],u=arguments[h+1];break}s.push(arguments[h])}"/"!==l.charAt(0)&&(l="/"+o.route.base+l);do var w=t().slice(-17);while(i.res[w]);d&&(i.res[w]=d,u&&(i.err[w]=u),setTimeout(function(){c=!0,!i.pgObj.destroyed&&i.res[w]&&(delete i.res[w],u&&(delete i.err[w],u.call(a)))},fw.timeout));var g=function(){c||(c=!0,i.used=!0,n.send(JSON.stringify([r,w,l,s])))};"connected"===e?g():(f.push(g),v()),fw.debug&&console.log("RPC "+l+" "+JSON.stringify(s))},a.msg=function(e,t){i.on(e,t)},a.msgOff=function(e,t){i.off(e,t)},i},A=function(t){"connected"===e&&t.obj.emit("socketConnect")},k=function(t){if(t.connId){var o=l[t.connId];delete l[t.connId],o.used&&"connected"===e&&n.send(JSON.stringify(["","end",t.connId])),t.obj.emit("socketDisconnect")}},C="/",J=function(){fw.workingServer&&(C=fw.workingServer[Math.floor(fw.workingServer.length*Math.random())],"/"!==C.slice(-1)&&(C+="/"))},P=function(){if("uninitialized"===e){e="initializing",h();var t=document.createElement("script");t.onerror=t.onabort=t.onload=t.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(this.onerror=this.onabort=this.onload=this.onreadystatechange=null,document.head.removeChild(this),"initializing"===e&&(e="uninitialized",g(P)))},J(),t.src=C+"~conf/sock.js?t="+(new Date).getTime()+(fw.debug?"":"&v="+fw.version)+"&a="+encodeURIComponent(a),document.head.appendChild(t)}};return fw._sockConfig=function(t){"initializing"===e&&(e="disconnected",o=C+"~sock",t&&(a=t,"web"!==fw.mode&&(localStorage["fw.sid"]=t),fw._renderWaitAuth&&fw._renderWaitAuth()),r=a,m())},{init:P,connInit:j,connStart:A,connEnd:k,getStatus:function(){return e}}}(),u=function(e){return e?!navigator.userAgent.match(new RegExp(e)):!1},s=function(e){e?e.constructor!==Array&&(e=[e]):e=[];for(var t=[],n=0;n<e.length;n++){var o=e[n];if("object"==typeof o){if(u(o.userAgent))continue;t=t.concat(fw.debug?o.src:o.minify||o.src)}else t.push(o)}return t},h=null,w={};fw.main=function(e){h=e};var g=function(e){if(!w[e]){w[e]=!0;var t=e;"/"===e.charAt(0)&&(t+=fw.debug?"?t="+(new Date).getTime():"?v="+fw.version,t=fw.cacheClientPrefix+t),fw._loadJs(function(){h=null})._loadJs(t)._loadJs(function(){h&&(w[e]=h,h=null)})}},v=function(e,t){return t.match(/^([-_a-z0-9]+:|\/\/)/i)||(".js"!==t.slice(-3)&&(t+=".js"),"/"!==t.charAt(0)&&(t="/"+e+t)),t},m=function(e,t){for(var n=s(t),o=0;o<n.length;o++){var r=n[o];r=v(e,r),g(r)}},p=function(e,t){for(var n=s(t),o=0;o<n.length;o++){var r=n[o];r=v(e,r);var i=w[r];if("function"==typeof i)try{i(E)}catch(a){setTimeout(function(){throw a},0)}}},b={},y="";fw._tmpls=function(e){if(y){var t=b[y]={};for(var n in e)t[n]="object"==typeof e[n]?e[n]:Handlebars.template(e[n]);y=""}};var S=function(e,t,n){var o=e;"/"===e.charAt(0)&&(o+=fw.debug?"?t="+(new Date).getTime():"?v="+fw.version,o=fw.cacheClientPrefix+o),b[e]||fw._loadJs(function(){y=e})._loadJs(o),fw._loadJs(function(){var o=b[e];if(o){for(var r in o)"i18n"!==r&&(t.tmpl[r]=o[r]);for(var r in o.i18n)n[r]=o.i18n[r]}})},_=function(e,t){var n={};E.tmpl.i18n=function(e){return n[e]||e};for(var o=s(t),r=0;r<o.length;r++){var i=o[r];".tmpl"!==i.slice(-5)&&(i+=".tmpl"),i+=fw.language?"."+fw.language+".js":".js",S(v(e,i),E,n)}},j=[],A=function(){for(var e=document.getElementsByTagName("link"),t=0;t<e.length;t++){var n=e[t];"string"==typeof n.getAttribute("fw")&&(document.head.removeChild(n),t--)}},k=function(){for(var e=j.pop(),t=0;t<e.length;t++)document.head.removeChild(e[t])},C=function(e,t){var n=document.createElement("link");n.onerror=n.onabort=n.onload=n.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(o.onerror=this.onerror=this.onabort=this.onload=this.onreadystatechange=null,t(this))},n.rel="stylesheet",n.type="text/css","/"===e.charAt(0)&&(e=fw.cacheClientPrefix+e+(fw.debug?"?t="+(new Date).getTime():"?v="+fw.version)),n.href=e,document.head.appendChild(n);var o=document.createElement("img");o.onerror=o.onload=function(){n.onload&&n.onload.call(n)},o.src=e},J=function(e,t,n){var o=!1,r=function(){o=!0},i=[];j.push(i);var a=s(t);if(!a)return n(),r;for(var l=a.length+1,f=function(){l--,l||n()},c=0;c<a.length;c++){var d=a[c];d.match(/^([-_a-z0-9]+:|\/\/)/i)||(".css"!==d.slice(-4)&&(d+=".stylus"!==d.slice(-7)?".stylus.css":".css"),"/"!==d.charAt(0)&&(d="/"+e+d)),C(d,function(e){return o?void document.head.removeChild(e):(i.push(e),void f())})}return f(),r},P=null,T=null,x=null;fw._routes=function(e,t){P=e,T=e.client,x=t};var N=function(e){e&&(this.parent=e.obj),this.tmpl={},this.events={},this.destroyed=!1},L=N.prototype=i;L.form=function(e,t,n,o){q(e,this,t,n,o)};var I="",R={},E=null;fw.getPath=function(){return I},fw.getArgs=function(){return R},fw.getPage=function(){return E},fw.host=location.host,fw.isLoading=function(){return D},fw.stopLoading=function(){D&&(fw.debug&&console.log("Loading aborted."),D=0,V&&V())};var O=0,D=0,z=[],V=null,W=function(){var e=z.pop();("out"===e.route.reload||"both"===e.route.reload)&&location.reload(),e.destroyed=!0,e.obj.destroyed=!0,e.obj.readyState="unloaded",d.connEnd(e),e.obj.emit("unload"),k(),e=z[z.length-1],E=e.obj,E.emit("childUnload")},M=function(e,t,n,o){fw.debug&&console.log("Loading Sub-Page: "+e);var r=z[z.length-1],i=T[e],l={destroyed:!1,routeId:e,route:i,obj:new N(r)};l.obj.readyState="loading",l.obj.routeId=e,r&&r.obj.emit("childLoadStart"),E=l.obj;var f=J(i.base,i.style,function(){f=null;var e=function(){D===n&&(t&&fw._loadJs(fw.mainServerPrefix+"~render"+I+"?t="+(new Date).getTime()+"&d="+t+"&a="+encodeURIComponent(a)+("web"===fw.mode?"":"&l="+fw.language))._loadJs(function(){if(1===O){document.title=fw._renderRes.title;var e=document.createElement("div");for(e.innerHTML=fw._renderRes.content;e.childNodes.length;){var t=e.childNodes[0];e.removeChild(t),document.body.appendChild(t)}}else r&&r.obj.emit("render",fw._renderRes);delete fw._renderRes}),_(i.base,i.tmpl),m(i.base,i.lib),m(i.base,i.main),fw._loadJs(function(){D===n&&(z.push(l),d.connInit(l),l.obj.readyState="loaded",p(i.base,i.main),l.obj.emit("load"),r&&r.obj.emit("childLoadEnd"),D===n&&d.connStart(l),o())})._loadJs())};t&&!a?fw._renderWaitAuth=function(){delete fw._renderWaitAuth,e()}:e()});V=function(){"loading"===l.obj.readyState&&(l.obj.readyState="stopped",f?f():(delete fw._renderWaitAuth,fw._loadJs(!1)),r&&r.obj.emit("childLoadStop"),o())}},U=function(e,t){if(D)return!1;var n=x(P,e);if("page"===n)return location.href="web"===fw.mode?e:fw.mainServerPrefix.slice(0,-1)+e,!0;if(!n)return!1;for(var o=n.id,r=n.route,i=n.args,a=[o],l=r;l.parent;l=T[l.parent])a.unshift(l.parent);if(a.length>16)return fw.debug&&console.error("Page stack is too deep. Loading failed."),!1;var f=D=++O;fw.loadingLogo.disabled||(fw._logo.style.display="block"),e=n.path,t&&t(e);for(var c=0;c<a.length&&z[c]&&a[c]===z[c].routeId;c++){var d=z[c].route.k;if(d){for(var u=0;u<d.length&&i[d[u]]===R[d[u]];u++);if(u<d.length)break}}for(var s=c,h=z.length-1;h>=s;h--)W();I=e,R=i;for(var c=s;c<a.length;c++){var l=T[a[c]];O>1&&("in"===l.reload||"both"===l.reload)&&location.reload()}var w=0,g=0;if(O>1||"web"!==fw.mode){for(var c=s;c<a.length&&!T[a[c]].render;c++);w=a.length-c,g=c}var h=s,v=function(){return D!==f?m():h>=a.length?(fw._logo&&(fw._logo.style.display="none"),D=0,m()):void(h===g?M(a[h++],w,f,v):M(a[h++],0,f,v))},m=function(){1===O&&"web"===fw.mode&&A()};return v(),!0},K=null;if("web"===fw.mode&&null===window.onpopstate)window.onpopstate=function(){fw.stopLoading(),location.pathname!==I&&U(location.pathname,function(e){history.replaceState({},"",e)})};else{var H=location.hash.slice(1)||("web"===fw.mode?location.pathname:"/"),B=function(e){fw.stopLoading(),H=e,"/"===H.charAt(0)&&U(H)};if(null===window.onhashchange)window.onhashchange=function(){var e=location.hash.slice(1)||("web"===fw.mode?location.pathname:"/");H!==e&&B(e)};else{K=document.createElement("iframe"),K.src="javascript:void(0)",K.tabindex="-1",K.style.display="none",document.body.appendChild(K);var F=K.contentWindow.document;F.open(),F.write("<html><body>"+F.createTextNode(H).nodeValue+"</body></html>"),F.close(),setInterval(function(){try{var e=K.contentWindow.document.body.innerText;if(H===e)return;location.href="#"+e,B(e)}catch(t){}},200)}}var G=function(e){var t=e.match(/^(https?:|)\/\/([^\/]+)(.*)$/);return t&&((t[1]&&t[1]!==location.protocol||t[2]!==location.host)&&(location.href=e),e=t[3]),"/"!==e.charAt(0)&&(e=location.pathname.slice(0,location.pathname.lastIndexOf("/")+1)+e),e};fw.go=function(e){return e!==I?(fw.stopLoading(),"number"==typeof e?history.go(e):(e=G(e),U(e,function(e){if("web"===fw.mode&&history.pushState)history.pushState({},"",e);else if(H=e,location.href="#"+e,K){var t=K.contentWindow.document;t.open(),t.write("<html><body>"+t.createTextNode(e).nodeValue+"</body></html>"),t.close()}}))):void 0},fw.redirect=function(e){return fw.stopLoading(),e=G(e),U(e,function(e){if("web"===fw.mode&&history.replaceState)history.replaceState({},"",e);else if(H=e,location.replace("#"+e),K){var t=K.contentWindow.document;t.open(),t.write("<html><body>"+t.createTextNode(e).nodeValue+"</body></html>"),t.close()}})},fw.open=function(e){e=G(e),window.open("web"===fw.mode&&history.replaceState?e:location.pathname+"#"+e)};var $=function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)};$(document,"click",function(e){if(e&&e.preventDefault){if(e.defaultPrevented)return;var t=e.target}else{if(window.event.returnValue===!1)return;var t=window.event.srcElement}if(!(e.buttons>1||e.ctrlKey||e.metaKey||e.altKey||e.shiftKey)){for(;t&&"A"!==t.tagName;)t=t.parentNode;if(t){var n=t.getAttribute("fw");if("string"==typeof n&&"A"===t.tagName){e&&e.preventDefault?e.preventDefault():window.event.returnValue=!1;var o=t.getAttribute("href");"_blank"===n?fw.open(o):"_redirect"===n?fw.redirect(o):fw.go(o)}}}});var q=function(e,t,n,o,r){$(e,"submit",function(i){if(i&&i.preventDefault){if(i.defaultPrevented)return;i.preventDefault()}else{if(window.event.returnValue===!1)return;window.event.returnValue=!1}var a=e.getAttribute("action"),l=e.getAttribute("method");l&&(a+=":"+l);var f=e.elements,c={};if(!n||n()!==!1){for(var d=0;d<f.length;d++){var u=f[d].name;u&&("radio"!==f[d].type&&"checkbox"!==f[d].type||f[d].checked!==!1)&&("[]"===u.slice(-2)?(u=u.slice(0,-2),c[u]?c[u].push(f[d].value):c[u]=[f[d].value]):c[u]=f[d].value)}t.rpc(a,c,o,r)}})},Q=function(){if(("web"===fw.mode||fw.workingServer)&&d.init(),"/"===location.hash.charAt(1))if("web"===fw.mode)location.replace(location.hash.slice(1));else var e=location.hash.slice(1);else if("web"===fw.mode)var e=location.pathname;else var e="/";U(e,function(t){e!==t&&"web"===fw.mode&&history.replaceState&&history.replaceState({},"",t)})};fw._loadJs(fw.cacheFwPrefix+"/routes.js"+(fw.debug?"?t="+(new Date).getTime():"?v="+fw.version))._loadJs(Q)._loadJs()}();
